# Nyxian 项目构建和打包流程分析

## 概述
Nyxian 是一个 iOS 应用开发工具，支持在设备上直接编译、构建和安装 iOS 应用。当用户点击"运行"或"打包"按钮时，会执行以下操作：

## 构建流程

### 1. 构建准备阶段 (prepare)
- **清理缓存**: 清理之前的构建文件
- **创建目录结构**: 创建 Payload 目录和 Bundle 目录
- **复制资源文件**: 将项目资源文件复制到 Bundle 目录
- **生成 Info.plist**: 动态创建应用的 Info.plist 文件，包含：
  - CFBundleExecutable (可执行文件名)
  - CFBundleIdentifier (Bundle ID)
  - CFBundleName (应用名称)
  - CFBundleShortVersionString (版本号)
  - CFBundleVersion (构建号)
  - MinimumOSVersion (最低系统版本)
  - UIDeviceFamily (支持的设备类型)
  - 其他配置信息

### 2. 编译阶段 (compile)
- **扫描源文件**: 识别需要编译的源文件
- **编译对象文件**: 使用 LLVM 编译器编译源文件为对象文件
- **处理依赖**: 处理头文件包含和依赖关系

### 3. 链接阶段 (link)
- **链接对象文件**: 将编译的对象文件链接成可执行文件
- **处理框架**: 链接必要的系统框架和第三方框架
- **符号解析**: 解析外部符号引用

### 4. 安装/打包阶段 (install)

#### 运行模式 (RunningApp)
当选择"运行"时：
1. **代码签名检查**: 验证是否有有效的代码签名证书
2. **应用签名**: 使用 `LCAppInfo.patchExecAndSignIfNeed` 对应用进行签名
3. **安装应用**: 使用 `LDEApplicationWorkspace.installApplication` 安装到设备
4. **启动应用**: 使用 `LDEProcessManager.spawnProcess` 启动应用

#### 打包模式 (InstallPackagedApp)
当选择"导出"时：
1. **创建 ZIP 包**: 使用 `zipDirectoryAtPath` 将整个 Payload 目录打包成 ZIP 文件
2. **分享文件**: 调用 `share` 函数打开系统分享界面
3. **清理临时文件**: 分享完成后删除临时文件

## 关键组件

### Builder.swift
- **主要构建逻辑**: 包含完整的构建流程
- **进度管理**: 显示构建进度和状态
- **错误处理**: 捕获和报告构建错误

### zip.m
- **ZIP 打包功能**: 使用 libarchive 库创建 ZIP 文件
- **目录遍历**: 递归遍历目录结构
- **文件压缩**: 将文件压缩到 ZIP 包中

### 权限和签名
- **代码签名**: 使用导入的证书对应用进行签名
- **权限申请**: 包含大量系统权限的使用描述
- **沙盒配置**: 配置应用的沙盒环境

## 构建输出

### 运行模式输出
- 直接在设备上安装并运行应用
- 应用会出现在设备主屏幕上
- 支持调试和日志查看

### 打包模式输出
- 生成 ZIP 格式的应用包
- 可以通过分享功能导出到其他应用
- 支持通过其他工具（如 AltStore、Sideloadly）安装

## 技术特点

1. **本地编译**: 在 iOS 设备上直接编译 C/C++/Objective-C 代码
2. **LLVM 集成**: 使用 LLVM 编译器工具链
3. **代码签名**: 支持自定义代码签名
4. **沙盒环境**: 在受限环境中运行和安装应用
5. **多架构支持**: 支持 arm64 架构

## 注意事项

- 需要有效的开发者证书进行代码签名
- 构建的应用只能在已签名的设备上运行
- 某些系统 API 可能受到沙盒限制
- 构建过程需要足够的存储空间

这个构建系统使得开发者可以在 iOS 设备上直接进行应用开发，无需 Mac 电脑，是一个创新的移动端开发解决方案。
